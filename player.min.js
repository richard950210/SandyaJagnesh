var tag = document.createElement("script");
tag.src = "https://www.youtube.com/iframe_api";
var firstScriptTag = document.getElementsByTagName("script")[0];
firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

// Variables for YouTube player and audio element
var player;
const audioElement = document.getElementById("audio");
const musicBtn = document.getElementById("music-btn");
const musicPlayerDiv = document.querySelector(".music-player");

function onYouTubeIframeAPIReady() {
    if ($("#videoId").val()) {
        player = new YT.Player("youtube-player", {
            height: "390",
            width: "640",
            videoId: $("#videoId").val(),
            playerVars: { playsinline: 1, loop: 1 },
            events: {
                onReady: onPlayerReady,
            }
        });
    }
}

function onPlayerReady(e) {
    player.loadVideoById({
        videoId: $("#videoId").val(),
        startSeconds: $("#videoStart").val(),
        endSeconds: $("#videoEnd").val()
    });
}

// Toggle play/pause for both audio and YouTube
musicBtn.addEventListener("click", function() {
    if ($("#videoId").val()) {
        // YouTube Player Handling
        if (player.getPlayerState() !== 1) {  // Not playing
            playMusic();
            musicPlayerDiv.classList.remove("paused");
        } else {
            pauseMusic();
            musicPlayerDiv.classList.add("paused");
        }
    } else {
        // Audio Player Handling
        if (audioElement.paused) {
            audioElement.play();
            musicPlayerDiv.classList.remove("paused");
        } else {
            audioElement.pause();
            musicPlayerDiv.classList.add("paused");
        }
    }
});

// YouTube controls
function playMusic() {
    if (player) player.playVideo();
}

function pauseMusic() {
    if (player) player.pauseVideo();
}

// Handle visibility changes for better resource management
document.addEventListener("visibilitychange", () => {
    if (document.hidden) {
        if ($("#videoId").val()) {
            pauseMusic();
        } else {
            audioElement.pause();
        }
        musicPlayerDiv.classList.add("paused");
    }
});
